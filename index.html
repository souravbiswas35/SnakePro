<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Snake Pro ‚Äî Dashboard</title>
<link rel="stylesheet" href="style.css">
<style>
#app{position:relative;min-height:100vh;display:flex;flex-direction:column;}
main{flex:1;padding:0 20px 40px;max-width:1120px;margin:0 auto;width:100%;position:relative;z-index:1;}
header{padding:22px 20px 0;max-width:1120px;margin:0 auto;width:100%;position:relative;z-index:1;display:flex;align-items:center;justify-content:space-between;margin-bottom:26px;}
.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{width:46px;height:46px;border-radius:11px;background:linear-gradient(135deg,#1a8a28,#0a4010);border:1px solid #2aaa38;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 18px rgba(26,138,40,.4);animation:lpulse 3s ease-in-out infinite;}
@keyframes lpulse{0%,100%{box-shadow:0 0 18px rgba(58,255,80,.3);}50%{box-shadow:0 0 36px rgba(58,255,80,.65);}}
.logo-text h1{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;letter-spacing:3px;color:var(--glow);text-shadow:0 0 18px rgba(58,255,80,.5);}
.logo-text span{font-size:9px;letter-spacing:4px;color:var(--text3);text-transform:uppercase;}
.hdr-right{display:flex;gap:8px;}

/* GRID */
.dash-grid{display:grid;grid-template-columns:330px 1fr;gap:16px;}
.span2{grid-column:span 2;}

/* HERO */
.hero-card{grid-column:span 2;background:linear-gradient(135deg,#091c0a 0%,#050e06 55%,#0c1c0e 100%);border:1px solid var(--border2);border-radius:16px;padding:26px 30px;display:flex;align-items:center;justify-content:space-between;gap:20px;position:relative;overflow:hidden;box-shadow:0 0 55px rgba(58,255,80,.07),inset 0 1px 0 rgba(58,255,80,.08);}
.hero-card::before{content:'';position:absolute;top:-40%;right:-8%;width:360px;height:360px;border-radius:50%;background:radial-gradient(circle,rgba(58,255,80,.05) 0%,transparent 70%);pointer-events:none;}
.hero-left h2{font-family:'Orbitron',monospace;font-size:26px;font-weight:900;letter-spacing:2px;color:#e0ffe4;margin-bottom:5px;text-shadow:0 0 28px rgba(58,255,80,.28);}
.hero-left p{color:var(--text2);font-size:13px;margin-bottom:18px;}
.hero-stats{display:flex;gap:22px;}
.hstat .v{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:var(--gold);display:block;text-shadow:0 0 10px rgba(245,197,24,.45);}
.hstat .l{font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;}
.hero-right{display:flex;flex-direction:column;align-items:center;gap:12px;flex-shrink:0;}

/* HERO SNAKE PREVIEW */
#heroCanvas{border-radius:8px;background:#071008;border:1px solid var(--border);display:block;}

/* CUSTOMIZER */
.color-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:7px;margin-bottom:14px;}
.cswatch{aspect-ratio:1;border-radius:7px;cursor:pointer;border:2px solid transparent;transition:var(--t);position:relative;overflow:hidden;}
.cswatch:hover{transform:scale(1.07);}
.cswatch.active{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.18);transform:scale(1.1);}
.cswatch::after{content:'‚úì';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:900;opacity:0;transition:opacity .18s;}
.cswatch.active::after{opacity:1;}

.skin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px;}
.skin-card{padding:9px 8px;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:var(--t);text-align:center;background:var(--bg3);}
.skin-card:hover{border-color:var(--border2);background:var(--surface2);}
.skin-card.active{border-color:var(--glow2);background:rgba(58,255,80,.07);box-shadow:0 0 10px rgba(58,255,80,.13);}
.skin-card .si{font-size:18px;margin-bottom:2px;}
.skin-card .sn{font-size:9px;letter-spacing:1px;color:var(--text2);text-transform:uppercase;}
.skin-card.active .sn{color:var(--glow);}

.pattern-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px;}
.pattern-card{padding:7px;border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:var(--t);text-align:center;background:var(--bg3);font-size:9px;letter-spacing:1px;color:var(--text2);text-transform:uppercase;}
.pattern-card:hover{border-color:var(--border2);}
.pattern-card.active{border-color:var(--glow2);background:rgba(58,255,80,.07);color:var(--glow);}

.eye-grid{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;}
.eye-btn{padding:5px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:var(--t);font-size:11px;color:var(--text2);background:var(--bg3);}
.eye-btn:hover{border-color:var(--border2);}
.eye-btn.active{border-color:var(--glow2);color:var(--glow);background:rgba(58,255,80,.07);}

.preview-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:12px;}
#previewCanvas{border-radius:4px;display:block;}
.preview-label{font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;}

/* MODE GRID */
.mode-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.mode-card{padding:13px 13px 13px 16px;border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:var(--t);background:var(--bg3);position:relative;overflow:hidden;}
.mode-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;opacity:.5;transition:var(--t);}
.mode-card:hover{background:var(--surface);transform:translateY(-1px);}
.mode-card.active{box-shadow:0 0 18px var(--mc-shadow,rgba(58,255,80,.12));}
.mode-card.active::before{opacity:1;}
/* Per-mode colours */
.mode-card[data-mode="classic"] {--mc-bar:#3aff50;--mc-shadow:rgba(58,255,80,.15);}
.mode-card[data-mode="endless"] {--mc-bar:#7aacff;--mc-shadow:rgba(80,130,255,.15);}
.mode-card[data-mode="timed"]   {--mc-bar:#ff5555;--mc-shadow:rgba(255,60,60,.15);}
.mode-card[data-mode="maze"]    {--mc-bar:#c070ff;--mc-shadow:rgba(180,60,255,.15);}
.mode-card[data-mode="blitz"]   {--mc-bar:#ffaa40;--mc-shadow:rgba(255,150,30,.15);}
.mode-card[data-mode="zen"]     {--mc-bar:#40ffe0;--mc-shadow:rgba(40,220,200,.15);}
.mode-card::before{background:var(--mc-bar,#3aff50);}
.mode-card[data-mode="classic"].active{border-color:#2aaa38;background:rgba(58,255,80,.06);}
.mode-card[data-mode="endless"].active{border-color:#3868e0;background:rgba(80,130,255,.06);}
.mode-card[data-mode="timed"].active  {border-color:#dd3333;background:rgba(255,60,60,.06);}
.mode-card[data-mode="maze"].active   {border-color:#a040e0;background:rgba(180,60,255,.06);}
.mode-card[data-mode="blitz"].active  {border-color:#dd8820;background:rgba(255,150,30,.06);}
.mode-card[data-mode="zen"].active    {border-color:#20ccb0;background:rgba(40,220,200,.06);}
.mode-card .mi{font-size:22px;margin-bottom:4px;}
.mode-card .mn{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text);margin-bottom:3px;}
.mode-card[data-mode="classic"].active .mn{color:#3aff50;}
.mode-card[data-mode="endless"].active .mn{color:#9ac0ff;}
.mode-card[data-mode="timed"].active .mn  {color:#ff8080;}
.mode-card[data-mode="maze"].active .mn   {color:#d090ff;}
.mode-card[data-mode="blitz"].active .mn  {color:#ffcc70;}
.mode-card[data-mode="zen"].active .mn    {color:#60ffe8;}
.mode-card .md{font-size:10px;color:var(--text3);line-height:1.55;}
.mode-card .mf{font-size:8px;letter-spacing:1px;font-weight:700;text-transform:uppercase;margin-top:5px;opacity:.7;}
.mode-card[data-mode="classic"] .mf{color:#3aff50;}
.mode-card[data-mode="endless"] .mf{color:#7aacff;}
.mode-card[data-mode="timed"]   .mf{color:#ff6666;}
.mode-card[data-mode="maze"]    .mf{color:#c080ff;}
.mode-card[data-mode="blitz"]   .mf{color:#ffbb50;}
.mode-card[data-mode="zen"]     .mf{color:#50ffe8;}
.mode-badge{position:absolute;top:7px;right:7px;}

/* DIFF */
.diff-row{display:flex;gap:5px;}
.diff-btn{flex:1;padding:8px 3px;text-align:center;border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:var(--t);font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text2);background:var(--bg3);text-transform:uppercase;}
.diff-btn:hover{border-color:var(--border2);color:var(--text);}
.diff-btn[data-d="easy"].active{background:rgba(58,200,80,.13);border-color:#3ac850;color:#3ac850;}
.diff-btn[data-d="normal"].active{background:rgba(245,197,24,.13);border-color:var(--gold);color:var(--gold);}
.diff-btn[data-d="hard"].active{background:rgba(255,120,30,.13);border-color:#ff781e;color:#ff781e;}
.diff-btn[data-d="insane"].active{background:rgba(255,58,58,.13);border-color:var(--red);color:var(--red);}

/* SETTINGS */
.tog-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid rgba(28,68,32,.3);}
.tog-row:last-child{border-bottom:none;}
.tinfo .tl{font-size:12px;font-weight:600;color:var(--text);}
.tinfo .td{font-size:10px;color:var(--text3);margin-top:1px;}

/* SCORES */
.scores-card{grid-column:span 2;}
.chart-wrap{height:75px;background:var(--bg3);border-radius:8px;overflow:hidden;margin-top:7px;}
#scoreChart{width:100%;height:100%;}
.empty-scores{text-align:center;padding:36px;color:var(--text3);font-size:13px;}
.empty-icon{font-size:30px;display:block;margin-bottom:8px;opacity:.5;}

@media(max-width:900px){.dash-grid{grid-template-columns:1fr;}.span2,.hero-card,.scores-card{grid-column:span 1;}.hero-card{flex-direction:column;text-align:center;}.hero-stats{justify-content:center;}#heroCanvas{display:none;}header{padding:14px 14px 0;margin-bottom:16px;}main{padding:0 10px 28px;}.color-grid{grid-template-columns:repeat(5,1fr);}.mode-grid{grid-template-columns:1fr 1fr;}}
@media(max-width:480px){.logo-text h1{font-size:15px;}.hero-left h2{font-size:18px;}.mode-grid{grid-template-columns:1fr;}.skin-grid{grid-template-columns:repeat(2,1fr);}.pattern-grid{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div>
<canvas id="bgParticles" style="position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.35;"></canvas>
<div id="notif-container"></div>

<div id="app">
<header>
  <div class="logo">
    <div class="logo-icon">üêç</div>
    <div class="logo-text"><h1>SNAKE PRO</h1><span>Ultimate Edition v2</span></div>
  </div>
  <div class="hdr-right">
    <button class="btn btn-secondary btn-sm" id="clearBtn">üóë Clear</button>
  </div>
</header>

<main class="page-fade">
<div class="dash-grid">

<!-- HERO -->
<div class="hero-card">
  <div class="hero-left">
    <h2>READY TO PLAY?</h2>
    <p>Customize your snake, pick a mode, and dominate the leaderboard.</p>
    <div class="hero-stats">
      <div class="hstat"><span class="v" id="hBest">0</span><span class="l">All-Time Best</span></div>
      <div class="hstat"><span class="v" id="hGames">0</span><span class="l">Games Played</span></div>
      <div class="hstat"><span class="v" id="hTotal">0</span><span class="l">Total Score</span></div>
    </div>
  </div>
  <div class="hero-right">
    <div style="position:relative;border-radius:10px;overflow:hidden;border:1px solid #267030;box-shadow:0 0 18px rgba(58,255,80,.15);">
      <canvas id="heroCanvas" width="240" height="120" style="display:block;"></canvas>
    </div>
    <button class="btn btn-primary btn-xl" onclick="launchGame()">‚ñ∂ &nbsp;PLAY NOW</button>
  </div>
</div>

<!-- CUSTOMIZER -->
<div class="card card-glow" style="grid-row:span 2;">
  <div class="sh"><h2>üé® Snake Customizer</h2><div class="sh-line"></div></div>

  <div class="preview-wrap">
    <canvas id="previewCanvas" width="280" height="80"></canvas>
    <span class="preview-label">Live Preview</span>
  </div>

  <label class="form-label">Color (12 options)</label>
  <div class="color-grid" id="colorGrid"></div>

  <label class="form-label">Skin Pattern (8 options)</label>
  <div class="skin-grid" id="skinGrid"></div>

  <label class="form-label">Body Design</label>
  <div class="pattern-grid" id="patternGrid"></div>

  <label class="form-label">Eye Style</label>
  <div class="eye-grid" id="eyeGrid"></div>

  <label class="form-label">Snake Size &nbsp;<span id="sizeLabel" style="color:var(--glow);font-family:'Orbitron',monospace;font-size:11px;"></span></label>
  <input type="range" id="sizeRange" min="0" max="3" step="1" value="1">
  <div style="display:flex;justify-content:space-between;margin-top:3px;margin-bottom:12px;">
    <span style="font-size:9px;color:var(--text3)">Slim</span><span style="font-size:9px;color:var(--text3)">Chunky</span>
  </div>

  <label class="form-label">Speed Bias &nbsp;<span id="speedLabel" style="color:var(--glow);font-family:'Orbitron',monospace;font-size:11px;"></span></label>
  <input type="range" id="speedBias" min="0" max="4" step="1" value="2">
  <div style="display:flex;justify-content:space-between;margin-top:3px;">
    <span style="font-size:9px;color:var(--text3)">Slow</span><span style="font-size:9px;color:var(--text3)">Fast</span>
  </div>
</div>

<!-- RIGHT COLUMN -->
<div style="display:flex;flex-direction:column;gap:14px;">

  <!-- MODES (6) -->
  <div class="card card-glow">
    <div class="sh"><h2>üéÆ Game Mode</h2><div class="sh-line"></div></div>
    <div class="mode-grid" id="modeGrid">
      <div class="mode-card active" data-mode="classic" onclick="selectMode('classic')">
        <div class="mi">üèÜ</div><div class="mn">Classic</div>
        <div class="md">10 progressive levels. Snake speeds up as you score. Walls are deadly.</div>
        <div class="mf">‚¨Ü Speed ¬∑ üèÅ Levels ¬∑ üíÄ Wall death</div>
      </div>
      <div class="mode-card" data-mode="endless" onclick="selectMode('endless')">
        <div class="mi">‚ôæÔ∏è</div><div class="mn">Endless</div>
        <div class="md">No levels, constant speed forever. Pure endurance ‚Äî how long can you last?</div>
        <div class="mf">üîí Fixed speed ¬∑ ‚àû No limit ¬∑ üíÄ Wall death</div>
      </div>
      <div class="mode-card" data-mode="timed" onclick="selectMode('timed')">
        <div class="mi">‚è±Ô∏è</div><div class="mn">Time Attack</div>
        <div class="md">90 seconds on the clock. Eat as much as possible before time expires!</div>
        <div class="mf">‚è∞ 90s ¬∑ üèÉ Race ¬∑ üåÄ Wrapping walls</div>
        <span class="mode-badge badge bg-red">HOT</span>
      </div>
      <div class="mode-card" data-mode="maze" onclick="selectMode('maze')">
        <div class="mi">üåÄ</div><div class="mn">Maze</div>
        <div class="md">Stone walls divide the arena into tight corridors. No wall wrap ‚Äî plan every move.</div>
        <div class="mf">üß± Walls ¬∑ üìê No wrap ¬∑ üèö Dark arena</div>
        <span class="mode-badge badge bg-purple">HARD</span>
      </div>
      <div class="mode-card" data-mode="blitz" onclick="selectMode('blitz')">
        <div class="mi">‚ö°</div><div class="mn">Fruit Blitz</div>
        <div class="md">6 fruits drop at once, each with its own timer ring. Eat fast or watch them vanish!</div>
        <div class="mf">üçé Multi-fruit ¬∑ ‚è≥ Timers ¬∑ üí• Combo rush</div>
        <span class="mode-badge badge bg-orange">NEW</span>
      </div>
      <div class="mode-card" data-mode="zen" onclick="selectMode('zen')">
        <div class="mi">üßò</div><div class="mn">Zen</div>
        <div class="md">Walls wrap around. No self-collision death. Calm breathing speed ‚Äî just grow.</div>
        <div class="mf">üåÄ Wrap ¬∑ üëª No self-death ¬∑ üåø Chill</div>
        <span class="mode-badge badge bg-blue">CHILL</span>
      </div>
    </div>
  </div>

  <!-- DIFFICULTY -->
  <div class="card card-glow">
    <div class="sh"><h2>‚ö° Difficulty</h2><div class="sh-line"></div></div>
    <div class="diff-row">
      <div class="diff-btn" data-d="easy"   onclick="selectDiff('easy')">Easy</div>
      <div class="diff-btn active" data-d="normal" onclick="selectDiff('normal')">Normal</div>
      <div class="diff-btn" data-d="hard"   onclick="selectDiff('hard')">Hard</div>
      <div class="diff-btn" data-d="insane" onclick="selectDiff('insane')">Insane</div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="card card-glow">
    <div class="sh"><h2>‚öôÔ∏è Settings</h2><div class="sh-line"></div></div>
    <div class="tog-row"><div class="tinfo"><div class="tl">Sound Effects</div><div class="td">Eat, crash and level-up sounds</div></div><label class="toggle"><input type="checkbox" id="togSound" checked><span class="tslider"></span></label></div>
    <div class="tog-row"><div class="tinfo"><div class="tl">Screen Shake</div><div class="td">Camera shakes on crash</div></div><label class="toggle"><input type="checkbox" id="togShake" checked><span class="tslider"></span></label></div>
    <div class="tog-row"><div class="tinfo"><div class="tl">Show Grid</div><div class="td">Subtle grid on the board</div></div><label class="toggle"><input type="checkbox" id="togGrid"><span class="tslider"></span></label></div>
    <div class="tog-row"><div class="tinfo"><div class="tl">Particles</div><div class="td">Explosion effects on eating</div></div><label class="toggle"><input type="checkbox" id="togParticles" checked><span class="tslider"></span></label></div>
    <div class="tog-row"><div class="tinfo"><div class="tl">Ghost Trail</div><div class="td">Fading tail on snake</div></div><label class="toggle"><input type="checkbox" id="togTrail" checked><span class="tslider"></span></label></div>
  </div>
</div>

<!-- SCORES -->
<div class="card card-glow scores-card">
  <div class="sh"><h2>üèÖ Score History</h2><div class="sh-line"></div></div>
  <div class="tab-bar" id="scoreTabBar">
    <button class="tab-btn active" data-tab="all"    onclick="switchTab('all')">All</button>
    <button class="tab-btn" data-tab="classic" onclick="switchTab('classic')">Classic</button>
    <button class="tab-btn" data-tab="endless" onclick="switchTab('endless')">Endless</button>
    <button class="tab-btn" data-tab="timed"   onclick="switchTab('timed')">Timed</button>
    <button class="tab-btn" data-tab="maze"    onclick="switchTab('maze')">Maze</button>
    <button class="tab-btn" data-tab="blitz"   onclick="switchTab('blitz')">Blitz</button>
    <button class="tab-btn" data-tab="zen"     onclick="switchTab('zen')">Zen</button>
  </div>
  <div style="overflow-x:auto;">
    <table class="score-table">
      <thead><tr><th style="width:36px">#</th><th>Score</th><th>Mode</th><th>Diff</th><th>Length</th><th>Date</th><th>Time</th></tr></thead>
      <tbody id="scoreTbody"></tbody>
    </table>
    <div id="scoreEmpty" class="empty-scores" style="display:none"><span class="empty-icon">üìã</span>No scores yet ‚Äî play a game!</div>
  </div>
  <div class="sh" style="margin-top:16px;"><h2>üìà Score Trend</h2><div class="sh-line"></div></div>
  <div class="chart-wrap"><canvas id="scoreChart"></canvas></div>
</div>

<!-- ACHIEVEMENTS -->
<div class="card card-glow span2">
  <div class="sh"><h2>üèÜ Achievements</h2><div class="sh-line"></div><span id="achProg" class="badge bg-gold" style="flex-shrink:0">0 / 14</span></div>
  <div class="ach-grid" id="achGrid"></div>
</div>

</div><!-- dash-grid -->
</main>
</div>

<script>
'use strict';
// ===================== DATA =====================
const SNAKE_COLORS = [
  {id:'green',  name:'Classic',   head:'#52e030',body:'#2aaa14',dark:'#165a08'},
  {id:'lime',   name:'Toxic',     head:'#c8ff30',body:'#8acc10',dark:'#4a7800'},
  {id:'cyan',   name:'Ice',       head:'#30d8e8',body:'#10a0c0',dark:'#085878'},
  {id:'blue',   name:'Royal',     head:'#4080ff',body:'#2050d0',dark:'#102880'},
  {id:'purple', name:'Shadow',    head:'#a060ff',body:'#7030d0',dark:'#3a1070'},
  {id:'pink',   name:'Neon Pink', head:'#ff50b0',body:'#d02080',dark:'#780040'},
  {id:'red',    name:'Crimson',   head:'#ff5040',body:'#d01820',dark:'#780008'},
  {id:'orange', name:'Ember',     head:'#ff8820',body:'#d05808',dark:'#783000'},
  {id:'yellow', name:'Gold Rush', head:'#ffe040',body:'#c0a000',dark:'#785000'},
  {id:'white',  name:'Ghost',     head:'#e8ffe8',body:'#a0c8a0',dark:'#507050'},
  {id:'teal',   name:'Deep Sea',  head:'#20e8b0',body:'#10b080',dark:'#085840'},
  {id:'magenta',name:'Aurora',    head:'#ff30c0',body:'#c010a0',dark:'#700060'},
];
const SNAKE_SKINS = [
  {id:'smooth', name:'Smooth', icon:'üü©'},
  {id:'scales', name:'Scales', icon:'üêç'},
  {id:'diamond',name:'Diamond',icon:'üíé'},
  {id:'neon',   name:'Neon',   icon:'‚ö°'},
  {id:'dashed', name:'Dashed', icon:'„Ä∞Ô∏è'},
  {id:'fire',   name:'Fire',   icon:'üî•'},
  {id:'dots',   name:'Dots',   icon:'üî¥'},
  {id:'stripes',name:'Stripes',icon:'ü¶ì'},
];
const BODY_PATTERNS = [
  {id:'round',   name:'Round'},
  {id:'square',  name:'Square'},
  {id:'pill',    name:'Pill'},
  {id:'wave',    name:'Wave'},
  {id:'hex',     name:'Hex'},
  {id:'star',    name:'Star'},
];
const EYE_STYLES = [
  {id:'slit',   name:'Slit'},
  {id:'round',  name:'Round'},
  {id:'angry',  name:'Angry'},
  {id:'cute',   name:'Cute'},
  {id:'alien',  name:'Alien'},
];
const ACHIEVEMENTS = [
  {id:'first',    icon:'üéÆ',name:'First Game',   desc:'Play your first game',             chk:(s,g)=>g.gamesPlayed>=1},
  {id:'s10',      icon:'‚≠ê',name:'Rising Star',  desc:'Reach score 10',                  chk:(s)=>s>=10},
  {id:'s50',      icon:'üåü',name:'High Achiever',desc:'Reach score 50',                  chk:(s)=>s>=50},
  {id:'s100',     icon:'üíØ',name:'Centurion',    desc:'Reach score 100',                 chk:(s)=>s>=100},
  {id:'s200',     icon:'üèÜ',name:'Legend',       desc:'Reach score 200',                 chk:(s)=>s>=200},
  {id:'g10',      icon:'üîÅ',name:'Veteran',      desc:'Play 10 games',                   chk:(s,g)=>g.gamesPlayed>=10},
  {id:'g50',      icon:'üéØ',name:'Grinder',      desc:'Play 50 games',                   chk:(s,g)=>g.gamesPlayed>=50},
  {id:'classic30',icon:'üëë',name:'Classic King', desc:'Score 30 in Classic',             chk:(s,g,r)=>r&&r.mode==='classic'&&r.score>=30},
  {id:'timed25',  icon:'‚è±Ô∏è',name:'Speed Demon',  desc:'Score 25 in Time Attack',         chk:(s,g,r)=>r&&r.mode==='timed'&&r.score>=25},
  {id:'maze20',   icon:'üåÄ',name:'Maze Master',  desc:'Score 20 in Maze',                chk:(s,g,r)=>r&&r.mode==='maze'&&r.score>=20},
  {id:'blitz30',  icon:'‚ö°',name:'Blitz King',   desc:'Score 30 in Fruit Blitz',         chk:(s,g,r)=>r&&r.mode==='blitz'&&r.score>=30},
  {id:'zen50',    icon:'üßò',name:'Zen Master',   desc:'Score 50 in Zen Mode',            chk:(s,g,r)=>r&&r.mode==='zen'&&r.score>=50},
  {id:'len50',    icon:'üêç',name:'Long Snake',   desc:'Reach length 50',                 chk:(s,g,r)=>r&&r.length>=50},
  {id:'allmode',  icon:'üåà',name:'Completionist',desc:'Play all 6 modes at least once',  chk:(s,g)=>{const modes=new Set((g.modesPlayed||[]));return modes.size>=6;}},
];

// ===================== STATE =====================
let cfg = {
  color:'green',skin:'smooth',pattern:'round',eyeStyle:'slit',
  mode:'classic',diff:'normal',
  snakeSize:1,speedBias:2,
  sound:true,shake:true,grid:false,particles:true,trail:true,
};
let history = [];
let gstats  = {gamesPlayed:0,totalScore:0,bestScore:0,modesPlayed:[]};
let unlocked = new Set();
let currentTab = 'all';

// ===================== STORAGE =====================
function save() {
  try {
    localStorage.setItem('sp2_cfg',     JSON.stringify(cfg));
    localStorage.setItem('sp2_history', JSON.stringify(history));
    localStorage.setItem('sp2_gstats',  JSON.stringify(gstats));
    localStorage.setItem('sp2_ach',     JSON.stringify([...unlocked]));
  } catch(e){}
}
function load() {
  try {
    const c=localStorage.getItem('sp2_cfg');     if(c) Object.assign(cfg, JSON.parse(c));
    const h=localStorage.getItem('sp2_history'); if(h) history=JSON.parse(h);
    const g=localStorage.getItem('sp2_gstats');  if(g) Object.assign(gstats, JSON.parse(g));
    const a=localStorage.getItem('sp2_ach');     if(a) unlocked=new Set(JSON.parse(a));
  } catch(e){}
}

// ===================== BUILD UI =====================
function buildColorGrid() {
  const el=document.getElementById('colorGrid'); el.innerHTML='';
  SNAKE_COLORS.forEach(c=>{
    const d=document.createElement('div');
    d.className='cswatch'+(cfg.color===c.id?' active':'');
    d.style.background=`linear-gradient(135deg,${c.head},${c.dark})`;
    d.title=c.name;
    d.onclick=()=>{cfg.color=c.id;buildColorGrid();renderPreview();save();};
    el.appendChild(d);
  });
}
function buildSkinGrid() {
  const el=document.getElementById('skinGrid'); el.innerHTML='';
  SNAKE_SKINS.forEach(s=>{
    const d=document.createElement('div');
    d.className='skin-card'+(cfg.skin===s.id?' active':'');
    d.innerHTML=`<div class="si">${s.icon}</div><div class="sn">${s.name}</div>`;
    d.onclick=()=>{cfg.skin=s.id;buildSkinGrid();renderPreview();save();};
    el.appendChild(d);
  });
}
function buildPatternGrid() {
  const el=document.getElementById('patternGrid'); el.innerHTML='';
  BODY_PATTERNS.forEach(p=>{
    const d=document.createElement('div');
    d.className='pattern-card'+(cfg.pattern===p.id?' active':'');
    d.textContent=p.name;
    d.onclick=()=>{cfg.pattern=p.id;buildPatternGrid();renderPreview();save();};
    el.appendChild(d);
  });
}
function buildEyeGrid() {
  const el=document.getElementById('eyeGrid'); el.innerHTML='';
  EYE_STYLES.forEach(e=>{
    const d=document.createElement('div');
    d.className='eye-btn'+(cfg.eyeStyle===e.id?' active':'');
    d.textContent=e.name;
    d.onclick=()=>{cfg.eyeStyle=e.id;buildEyeGrid();renderPreview();save();};
    el.appendChild(d);
  });
}

function selectMode(m) {
  cfg.mode=m;
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.toggle('active',c.dataset.mode===m));
  save();
}
function selectDiff(d) {
  cfg.diff=d;
  document.querySelectorAll('.diff-btn').forEach(b=>b.classList.toggle('active',b.dataset.d===d));
  save();
}

// ===================== PREVIEW RENDERER =====================
let previewT=0, heroT=0;

function lerp(a,b,t){return a+(b-a)*t;}
function hexToRgb(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return[r,g,b];}
function lerpHex(h1,h2,t){const [r1,g1,b1]=hexToRgb(h1),[r2,g2,b2]=hexToRgb(h2);return`rgb(${Math.round(lerp(r1,r2,t))},${Math.round(lerp(g1,g2,t))},${Math.round(lerp(b1,b2,t))})`;}

function drawSnakePreview(ctx, segs, pal, r, t, dir) {
  if(segs.length<2) return;
  // connections
  for(let i=segs.length-1;i>0;i--){
    const a=segs[i],b=segs[i-1],tc=i/segs.length;
    ctx.strokeStyle=lerpHex(pal.body,pal.dark,tc);
    ctx.lineWidth=(r*2)-2; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  }
  // segments
  for(let i=segs.length-1;i>=1;i--){
    const s=segs[i],tc=i/segs.length;
    const col=lerpHex(pal.body,pal.dark,tc);
    drawSegPreview(ctx,s.x,s.y,r,col,pal,i,t);
  }
  // head
  const h=segs[0], angle=Math.atan2(dir.y,dir.x);
  drawHeadPreview(ctx,h.x,h.y,r,pal,angle,t);
}

function drawSegPreview(ctx,x,y,r,col,pal,idx,t){
  const g=ctx.createRadialGradient(x-r*.3,y-r*.3,r*.04,x,y,r);
  g.addColorStop(0,lightenRgb(col,45)); g.addColorStop(1,col);
  ctx.save();
  // body shape
  switch(cfg.pattern){
    case 'square':
      ctx.fillStyle=g; ctx.beginPath();
      ctx.roundRect(x-r*.9,y-r*.9,r*1.8,r*1.8,3); ctx.fill(); break;
    case 'pill':
      ctx.fillStyle=g; ctx.beginPath();
      ctx.ellipse(x,y,r*.9,r*.65,0,0,Math.PI*2); ctx.fill(); break;
    default:
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
  applySkin(ctx,x,y,r,pal,cfg.skin,idx,t);
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=.8;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.stroke();
  ctx.restore();
}

function applySkin(ctx,x,y,r,pal,skin,idx,t){
  switch(skin){
    case 'scales':
      if(idx%2===0){ctx.fillStyle='rgba(0,0,0,.16)';ctx.beginPath();ctx.ellipse(x,y,r*.67,r*.47,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,255,.07)';ctx.beginPath();ctx.ellipse(x-r*.1,y-r*.1,r*.5,r*.33,-.3,0,Math.PI*2);ctx.fill();}break;
    case 'diamond':
      ctx.fillStyle='rgba(255,255,255,.18)';ctx.beginPath();ctx.moveTo(x,y-r*.72);ctx.lineTo(x+r*.52,y);ctx.lineTo(x,y+r*.72);ctx.lineTo(x-r*.52,y);ctx.closePath();ctx.fill();break;
    case 'neon':
      ctx.save();ctx.shadowColor=pal.head;ctx.shadowBlur=10;ctx.strokeStyle=pal.head+'70';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,y,r-1,0,Math.PI*2);ctx.stroke();ctx.restore();break;
    case 'dashed':
      if(idx%3===0){ctx.fillStyle='rgba(255,255,255,.26)';ctx.beginPath();ctx.arc(x,y,r*.34,0,Math.PI*2);ctx.fill();}break;
    case 'fire':
      if(idx%2===0){ctx.fillStyle='rgba(255,120,0,.2)';ctx.beginPath();ctx.arc(x,y-r*.15,r*.54,0,Math.PI*2);ctx.fill();}break;
    case 'dots':
      [{dx:r*.35,dy:0},{dx:-r*.35,dy:0},{dx:0,dy:r*.35},{dx:0,dy:-r*.35}].forEach(p=>{
        ctx.fillStyle='rgba(255,255,255,.22)';ctx.beginPath();ctx.arc(x+p.dx,y+p.dy,r*.14,0,Math.PI*2);ctx.fill();
      });break;
    case 'stripes':
      for(let k=-1;k<=1;k++){ctx.fillStyle='rgba(0,0,0,.12)';ctx.beginPath();ctx.fillRect(x+k*r*.35-1,y-r*.9,2,r*1.8);}break;
  }
}

function drawHeadPreview(ctx,x,y,r,pal,angle,t){
  ctx.save(); ctx.translate(x,y); ctx.rotate(angle);
  // body connector - thick
  ctx.strokeStyle=pal.body; ctx.lineWidth=r*2; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-r*.8,0); ctx.stroke();
  const g=ctx.createRadialGradient(-r*.2,-r*.25,r*.04,0,0,r*1.12);
  g.addColorStop(0,pal.head); g.addColorStop(.5,pal.body); g.addColorStop(1,pal.dark);
  ctx.beginPath(); ctx.ellipse(0,0,r*1.12,r,0,0,Math.PI*2);
  ctx.fillStyle=g; ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.3)'; ctx.lineWidth=1.4; ctx.stroke();
  if(cfg.skin==='neon'){ctx.save();ctx.shadowColor=pal.head;ctx.shadowBlur=14;ctx.strokeStyle=pal.head+'90';ctx.lineWidth=1.8;ctx.beginPath();ctx.ellipse(0,0,r*1.12,r,0,0,Math.PI*2);ctx.stroke();ctx.restore();}
  ctx.fillStyle='rgba(255,255,255,.16)'; ctx.beginPath(); ctx.ellipse(-r*.1,-r*.28,r*.52,r*.28,-.2,0,Math.PI*2); ctx.fill();
  drawEyes(ctx,r,t);
  const tw=Math.sin(t*8)*.4,tl=r*.55;
  ctx.strokeStyle='#dd2060'; ctx.lineWidth=1.8; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(r*1.0,0); ctx.lineTo(r*1.0+tl*.5,0); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(r*1.0+tl*.4,0); ctx.lineTo(r*1.0+tl,-r*.32+tw*r); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(r*1.0+tl*.4,0); ctx.lineTo(r*1.0+tl, r*.32+tw*r); ctx.stroke();
  ctx.restore();
}

function drawEyes(ctx,r,t){
  const ey=r*.5, ex=r*.35;
  [-1,1].forEach(side=>{
    ctx.beginPath(); ctx.arc(ex,side*ey,r*.27,0,Math.PI*2);
    ctx.fillStyle='#fff'; ctx.fill();
    ctx.strokeStyle='#222'; ctx.lineWidth=.7; ctx.stroke();
    // pupil by style
    ctx.save(); ctx.translate(ex+r*.06,side*ey);
    switch(cfg.eyeStyle){
      case 'slit':   ctx.beginPath();ctx.ellipse(0,0,r*.09,r*.19,0,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill();break;
      case 'round':  ctx.beginPath();ctx.arc(0,0,r*.16,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill();break;
      case 'angry':  ctx.beginPath();ctx.arc(0,0,r*.13,0,Math.PI*2);ctx.fillStyle='#300';ctx.fill();ctx.strokeStyle='#f00';ctx.lineWidth=.5;ctx.stroke();break;
      case 'cute':   ctx.beginPath();ctx.arc(0,0,r*.18,0,Math.PI*2);ctx.fillStyle='#224';ctx.fill();ctx.fillStyle='rgba(100,180,255,.5)';ctx.beginPath();ctx.arc(0,0,r*.08,0,Math.PI*2);ctx.fill();break;
      case 'alien':  ctx.beginPath();ctx.ellipse(0,0,r*.2,r*.1,0,0,Math.PI*2);ctx.fillStyle='#050';ctx.fill();break;
    }
    ctx.restore();
    // shine
    ctx.beginPath(); ctx.arc(ex-r*.04,side*ey-r*.08,r*.07,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,.85)'; ctx.fill();
  });
}

function lightenRgb(rgb,a){const m=(rgb.match(/\d+/g)||['80','160','40']).map(Number);return`rgb(${Math.min(255,m[0]+a)},${Math.min(255,m[1]+a)},${Math.min(255,m[2]+a)})`;}

// ===================== PREVIEW ANIMATION =====================
let previewAnimId=null;

// Hero snake physics state - persists between frames
const heroState = {
  path: [],          // [{x,y}] index 0 = head
  vx: -2.2,          // velocity
  vy: 0.5,
  initialized: false
};

function initHeroState(W, H) {
  if (heroState.initialized) return;
  // Start head near right side
  const startX = W - 28;
  const startY = H / 2;
  heroState.path = [];
  for (let i = 0; i < 11; i++) {
    heroState.path.push({ x: startX + i * 18, y: startY + Math.sin(i * 0.5) * 12 });
  }
  heroState.vx = -2.0;
  heroState.vy = 0.6;
  heroState.initialized = true;
}

function stepHeroSnake(W, H, r) {
  const MARGIN = r + 3;
  const BOTTOM_MARGIN = r + 18; // leave room for grass
  let nx = heroState.path[0].x + heroState.vx;
  let ny = heroState.path[0].y + heroState.vy;

  // Bounce off walls - STAY inside box
  if (nx >= W - MARGIN) { nx = W - MARGIN; heroState.vx = -Math.abs(heroState.vx); }
  if (nx <= MARGIN)      { nx = MARGIN;     heroState.vx =  Math.abs(heroState.vx); }
  if (ny >= H - BOTTOM_MARGIN) { ny = H - BOTTOM_MARGIN; heroState.vy = -Math.abs(heroState.vy); }
  if (ny <= MARGIN)             { ny = MARGIN;            heroState.vy =  Math.abs(heroState.vy); }

  // Gentle wobble
  heroState.vy += Math.sin(heroT * 3.1) * 0.06;
  heroState.vy = Math.max(-2.8, Math.min(2.8, heroState.vy));

  // Shift path - head at index 0
  heroState.path.unshift({ x: nx, y: ny });
  if (heroState.path.length > 12) heroState.path.pop();
}

function drawGardenBg(ctx, W, H, t) {
  // Dark green garden ground
  const bg = ctx.createLinearGradient(0, 0, 0, H);
  bg.addColorStop(0, '#041008');
  bg.addColorStop(1, '#081a0a');
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, W, H);

  // Subtle grid lines
  ctx.strokeStyle = 'rgba(58,255,80,.04)';
  ctx.lineWidth = 1;
  for (let x = 0; x < W; x += 20) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
  for (let y = 0; y < H; y += 20) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

  // Animated grass strip at bottom
  const grassH = 14;
  ctx.fillStyle = '#1a6010';
  ctx.fillRect(0, H - grassH, W, grassH);

  // Individual grass blades
  const bladeColors = ['#3ec820','#2aaa14','#4ad828','#1a9010','#60d840'];
  for (let i = 0; i < 30; i++) {
    const bx = (i / 30) * W + 4;
    const sway = Math.sin(t * 1.8 + i * 0.7) * 3.5;
    const bh = 8 + Math.sin(i * 1.3) * 4;
    ctx.save();
    ctx.strokeStyle = bladeColors[i % bladeColors.length];
    ctx.lineWidth = 1.5;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(bx, H - 2);
    ctx.quadraticCurveTo(bx + sway * 0.5, H - bh * 0.6, bx + sway, H - bh);
    ctx.stroke();
    ctx.restore();
  }

  // Colourful flowers along bottom
  const flowerData = [
    { x: 10,  col: '#ff60a0', center: '#ffe060' },
    { x: 36,  col: '#ffb030', center: '#ff5010' },
    { x: 64,  col: '#60c8ff', center: '#ffffff' },
    { x: 92,  col: '#c060ff', center: '#ffe080' },
    { x: 118, col: '#ff5050', center: '#fff060' },
    { x: 148, col: '#40e8b0', center: '#ffffff' },
    { x: 178, col: '#ff80c0', center: '#ffc040' },
    { x: 208, col: '#ffe040', center: '#ff8020' },
    { x: 230, col: '#8080ff', center: '#ffe0ff' },
  ];
  flowerData.forEach((f, fi) => {
    const bob = Math.sin(t * 1.4 + fi * 0.6) * 2.5;
    const sway = Math.sin(t * 1.0 + fi * 0.9) * 2;
    const stemH = 9 + Math.sin(fi * 1.1) * 3;
    const fx = f.x, fy = H - grassH + bob;

    // Stem
    ctx.save();
    ctx.strokeStyle = '#2aaa14';
    ctx.lineWidth = 1.2;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(fx, fy);
    ctx.quadraticCurveTo(fx + sway, fy - stemH * 0.5, fx + sway, fy - stemH);
    ctx.stroke();

    // Petals
    ctx.translate(fx + sway, fy - stemH);
    const pr = 3.5;
    for (let p = 0; p < 5; p++) {
      const pa = (p / 5) * Math.PI * 2 + t * 0.4;
      ctx.fillStyle = f.col + 'cc';
      ctx.beginPath();
      ctx.ellipse(Math.cos(pa) * pr * 1.2, Math.sin(pa) * pr * 1.2, pr, pr * 0.55, pa, 0, Math.PI * 2);
      ctx.fill();
    }
    // Centre dot
    ctx.fillStyle = f.center;
    ctx.beginPath();
    ctx.arc(0, 0, 2.2, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  });
}

function renderHero() {
  const cv = document.getElementById('heroCanvas');
  if (!cv) return;
  const ctx = cv.getContext('2d');
  const W = cv.width, H = cv.height;
  const pal = SNAKE_COLORS.find(c => c.id === cfg.color) || SNAKE_COLORS[0];
  const r = 11; // THICK

  initHeroState(W, H);
  stepHeroSnake(W, H, r);

  // Draw garden background with flowers + grass
  drawGardenBg(ctx, W, H, heroT);

  const path = heroState.path;
  if (path.length < 2) return;

  // Direction of head movement for face orientation
  const dx = path[0].x - path[1].x;
  const dy = path[0].y - path[1].y;
  const dn = Math.sqrt(dx * dx + dy * dy) || 1;
  const faceDir = { x: dx / dn, y: dy / dn };

  // Draw thick connections tail‚Üíhead
  for (let i = path.length - 1; i > 0; i--) {
    const tc = i / path.length;
    ctx.strokeStyle = lerpHex(pal.body, pal.dark, tc);
    ctx.lineWidth = r * 2;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(path[i].x, path[i].y);
    ctx.lineTo(path[i - 1].x, path[i - 1].y);
    ctx.stroke();
  }

  // Draw body segments
  for (let i = path.length - 1; i >= 1; i--) {
    const s = path[i];
    const tc = i / path.length;
    const col = lerpHex(pal.body, pal.dark, tc);
    const g = ctx.createRadialGradient(s.x - r * 0.3, s.y - r * 0.3, r * 0.04, s.x, s.y, r);
    g.addColorStop(0, lightenRgb(col, 50));
    g.addColorStop(1, col);
    ctx.save();
    ctx.beginPath();
    ctx.arc(s.x, s.y, r, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
    applySkin(ctx, s.x, s.y, r, pal, cfg.skin, i, heroT);
    ctx.strokeStyle = 'rgba(0,0,0,.22)';
    ctx.lineWidth = 0.8;
    ctx.beginPath();
    ctx.arc(s.x, s.y, r, 0, Math.PI * 2);
    ctx.stroke();
    ctx.restore();
  }

  // Draw head - always faces direction of travel
  drawHeadPreview(ctx, path[0].x, path[0].y, r, pal, Math.atan2(faceDir.y, faceDir.x), heroT);
}

function renderPreview() {
  const cv = document.getElementById('previewCanvas');
  if (!cv) return;
  const ctx = cv.getContext('2d'), W = cv.width, H = cv.height;
  const pal = SNAKE_COLORS.find(c => c.id === cfg.color) || SNAKE_COLORS[0];
  const r = 10 + cfg.snakeSize * 2; // thick

  // Garden background
  drawGardenBg(ctx, W, H, heroT);

  // S-curve snake going left ‚Üí head on RIGHT side
  const segs = [];
  for (let i = 0; i < 10; i++) {
    segs.push({
      x: W - 18 - i * 26,
      y: H / 2 - 10 + Math.sin(i * 0.7 + heroT * 0.8) * 18
    });
  }

  // Draw thick connections
  for (let i = segs.length - 1; i > 0; i--) {
    const tc = i / segs.length;
    ctx.strokeStyle = lerpHex(pal.body, pal.dark, tc);
    ctx.lineWidth = r * 2;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(segs[i].x, segs[i].y);
    ctx.lineTo(segs[i - 1].x, segs[i - 1].y);
    ctx.stroke();
  }
  // Draw segments
  for (let i = segs.length - 1; i >= 1; i--) {
    const s = segs[i];
    const tc = i / segs.length;
    const col = lerpHex(pal.body, pal.dark, tc);
    drawSegPreview(ctx, s.x, s.y, r, col, pal, i, heroT);
  }
  // Head faces RIGHT (positive x)
  drawHeadPreview(ctx, segs[0].x, segs[0].y, r, pal, 0, heroT);
}

function animateHero(){
  heroT+=0.025;
  renderPreview();
  renderHero();
  requestAnimationFrame(animateHero);
}

// ===================== SCORE TABLE =====================
function renderScoreTable(tab){
  currentTab=tab;
  const tbody=document.getElementById('scoreTbody');
  const empty=document.getElementById('scoreEmpty');
  tbody.innerHTML='';
  let rows=tab==='all'?[...history]:history.filter(s=>s.mode===tab);
  rows.sort((a,b)=>b.score-a.score);
  rows=rows.slice(0,20);
  if(!rows.length){empty.style.display='block';renderChart([]);return;}
  empty.style.display='none';
  const mc={classic:'bg-green',endless:'bg-blue',timed:'bg-red',maze:'bg-purple',blitz:'bg-orange',zen:'bg-blue'};
  const dc={easy:'#3ac850',normal:'#f5c518',hard:'#ff781e',insane:'#ff3a3a'};
  rows.forEach((r,i)=>{
    const ri=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1);
    const rc=i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
    const dt=new Date(r.ts);
    const ds=dt.toLocaleDateString();
    const ts2=dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const dur=r.duration?fmtDur(r.duration):'‚Äî';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="${rc}" style="font-family:'Orbitron',monospace;font-weight:700;">${ri}</td><td><span class="sv">${r.score}</span></td><td><span class="badge ${mc[r.mode]||'bg-green'}">${r.mode||'classic'}</span></td><td style="color:${dc[r.diff||'normal']};font-size:11px;font-weight:700;">${r.diff||'normal'}</td><td style="font-family:'Orbitron',monospace;font-size:11px;color:var(--text2);">${r.length||'‚Äî'}</td><td style="font-size:11px;color:var(--text3);">${ds}</td><td style="font-size:11px;color:var(--text3);">${dur}</td>`;
    tr.style.opacity='0';tr.style.transform='translateX(-8px)';
    tbody.appendChild(tr);
    requestAnimationFrame(()=>{tr.style.transition='opacity .28s ease,transform .28s ease';tr.style.opacity='1';tr.style.transform='none';});
  });
  const chartData=(tab==='all'?history:history.filter(s=>s.mode===tab)).slice(-15).map(s=>s.score);
  renderChart(chartData);
}

function fmtDur(ms){const s=Math.floor(ms/1000),m=Math.floor(s/60),sec=s%60;return m>0?`${m}m${sec}s`:`${sec}s`;}

function switchTab(t){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));
  renderScoreTable(t);
}

function renderChart(data){
  const cv=document.getElementById('scoreChart');
  const ctx=cv.getContext('2d');
  cv.width=cv.offsetWidth||800; cv.height=75;
  const W=cv.width,H=cv.height;
  ctx.clearRect(0,0,W,H);
  if(data.length<2){ctx.fillStyle='var(--text3)';ctx.font='11px Exo 2';ctx.textAlign='center';ctx.fillText('Not enough data',W/2,H/2);return;}
  const maxV=Math.max(...data,1),p=8;
  const pts=data.map((v,i)=>({x:p+(i/(data.length-1))*(W-p*2),y:H-p-(v/maxV)*(H-p*2)}));
  const fg=ctx.createLinearGradient(0,0,0,H);fg.addColorStop(0,'rgba(58,255,80,.22)');fg.addColorStop(1,'rgba(58,255,80,0)');
  ctx.beginPath();ctx.moveTo(pts[0].x,H);pts.forEach(p=>ctx.lineTo(p.x,p.y));ctx.lineTo(pts[pts.length-1].x,H);ctx.closePath();ctx.fillStyle=fg;ctx.fill();
  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<pts.length;i++){const cx=(pts[i-1].x+pts[i].x)/2;ctx.bezierCurveTo(cx,pts[i-1].y,cx,pts[i].y,pts[i].x,pts[i].y);}
  ctx.strokeStyle='#3aff50';ctx.lineWidth=2;ctx.stroke();
  pts.forEach((p,i)=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle=i===pts.length-1?'#f5c518':'#3aff50';ctx.fill();});
}

// ===================== ACHIEVEMENTS =====================
function renderAch(){
  const grid=document.getElementById('achGrid'); grid.innerHTML='';
  let u=0;
  ACHIEVEMENTS.forEach(a=>{
    const on=unlocked.has(a.id);if(on)u++;
    const d=document.createElement('div');
    d.className='ach-item'+(on?' unlocked':'');
    d.innerHTML=`<div class="ai">${a.icon}</div><div class="an">${a.name}</div><div class="ad">${a.desc}</div>`;
    grid.appendChild(d);
  });
  document.getElementById('achProg').textContent=`${u} / ${ACHIEVEMENTS.length}`;
}

function checkAch(record){
  const newly=[];
  ACHIEVEMENTS.forEach(a=>{
    if(!unlocked.has(a.id)&&a.chk(record.score,gstats,record)){unlocked.add(a.id);newly.push(a);}
  });
  newly.forEach(a=>notify(`üèÜ ${a.name} unlocked!`,'gold'));
  if(newly.length){renderAch();save();}
}

// ===================== HERO STATS =====================
function updateHeroStats(){
  document.getElementById('hBest').textContent=gstats.bestScore;
  document.getElementById('hGames').textContent=gstats.gamesPlayed;
  document.getElementById('hTotal').textContent=gstats.totalScore;
}

// ===================== NOTIFICATION =====================
function notify(msg,type='green'){
  const c=document.getElementById('notif-container');
  const el=document.createElement('div');
  el.className='notif';
  const colors={green:'var(--glow)',gold:'var(--gold)',red:'var(--red)'};
  el.style.borderLeft=`3px solid ${colors[type]||colors.green}`;
  el.textContent=msg;
  c.appendChild(el);
  setTimeout(()=>{el.classList.add('out');setTimeout(()=>el.remove(),320);},3200);
}

// ===================== LAUNCH =====================
function launchGame(){
  cfg.sound    =document.getElementById('togSound').checked;
  cfg.shake    =document.getElementById('togShake').checked;
  cfg.grid     =document.getElementById('togGrid').checked;
  cfg.particles=document.getElementById('togParticles').checked;
  cfg.trail    =document.getElementById('togTrail').checked;
  cfg.speedBias=parseInt(document.getElementById('speedBias').value);
  cfg.snakeSize=parseInt(document.getElementById('sizeRange').value);
  save();
  window.location.href='game.html';
}

// ===================== BG PARTICLES =====================
function initBgParticles(){
  const cv=document.getElementById('bgParticles');
  const ctx=cv.getContext('2d');
  function resize(){cv.width=window.innerWidth;cv.height=window.innerHeight;}
  resize(); window.addEventListener('resize',resize);
  const sparks=Array.from({length:38},()=>({x:Math.random()*9999,y:Math.random()*9999,vx:(Math.random()-.5)*.35,vy:(Math.random()-.5)*.35,r:Math.random()*1.8+.4,life:Math.random()}));
  function loop(){
    ctx.clearRect(0,0,cv.width,cv.height);
    sparks.forEach(s=>{
      s.x+=s.vx;s.y+=s.vy;s.life-=.0025;
      if(s.life<=0){s.life=1;s.x=Math.random()*cv.width;s.y=Math.random()*cv.height;}
      if(s.x<0||s.x>cv.width)s.vx*=-1;
      if(s.y<0||s.y>cv.height)s.vy*=-1;
      ctx.save();ctx.globalAlpha=s.life*.55;ctx.fillStyle='#3aff50';ctx.shadowColor='#3aff50';ctx.shadowBlur=5;
      ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();
    });
    requestAnimationFrame(loop);
  }
  loop();
}

// ===================== LABELS =====================
function updateLabels(){
  const sl=['Slim','Normal','Wide','Chunky'];
  const sp=['Very Slow','Slow','Normal','Fast','Very Fast'];
  document.getElementById('sizeLabel').textContent=sl[cfg.snakeSize]||'Normal';
  document.getElementById('speedLabel').textContent=sp[cfg.speedBias]||'Normal';
}

// ===================== INIT =====================
function init(){
  load();
  buildColorGrid(); buildSkinGrid(); buildPatternGrid(); buildEyeGrid();
  selectMode(cfg.mode); selectDiff(cfg.diff);
  document.getElementById('togSound').checked=cfg.sound;
  document.getElementById('togShake').checked=cfg.shake;
  document.getElementById('togGrid').checked=cfg.grid;
  document.getElementById('togParticles').checked=cfg.particles;
  document.getElementById('togTrail').checked=cfg.trail;
  document.getElementById('speedBias').value=cfg.speedBias;
  document.getElementById('sizeRange').value=cfg.snakeSize;
  updateLabels();
  updateHeroStats();
  renderScoreTable('all');
  renderAch();
  initBgParticles();
  animateHero();

  document.getElementById('speedBias').addEventListener('input',function(){cfg.speedBias=+this.value;updateLabels();save();});
  document.getElementById('sizeRange').addEventListener('input',function(){cfg.snakeSize=+this.value;updateLabels();renderPreview();save();});
  ['togSound','togShake','togGrid','togParticles','togTrail'].forEach(id=>{
    document.getElementById(id).addEventListener('change',()=>{
      cfg.sound=document.getElementById('togSound').checked;
      cfg.shake=document.getElementById('togShake').checked;
      cfg.grid=document.getElementById('togGrid').checked;
      cfg.particles=document.getElementById('togParticles').checked;
      cfg.trail=document.getElementById('togTrail').checked;
      save();
    });
  });
  document.getElementById('clearBtn').addEventListener('click',()=>{
    if(!confirm('Clear all data?')) return;
    history=[];gstats={gamesPlayed:0,totalScore:0,bestScore:0,modesPlayed:[]};unlocked=new Set();
    save();updateHeroStats();renderScoreTable(currentTab);renderAch();
    notify('Cleared.','red');
  });
  window.addEventListener('pageshow',()=>{
    load();
    const rec=sessionStorage.getItem('sp2_lastRecord');
    if(rec){
      sessionStorage.removeItem('sp2_lastRecord');
      const r=JSON.parse(rec);
      history.push(r);
      gstats.gamesPlayed++;
      gstats.totalScore+=r.score;
      if(r.score>gstats.bestScore) gstats.bestScore=r.score;
      if(!gstats.modesPlayed) gstats.modesPlayed=[];
      if(!gstats.modesPlayed.includes(r.mode)) gstats.modesPlayed.push(r.mode);
      save();
      checkAch(r);
      updateHeroStats();
      renderScoreTable(currentTab);
      renderAch();
      if(r.score>0) notify(`Game over! Score: ${r.score} üéØ`);
    }
  });
  window.addEventListener('resize',()=>{
    const d=(currentTab==='all'?history:history.filter(s=>s.mode===currentTab)).slice(-15).map(s=>s.score);
    renderChart(d);
  });
}

init();
</script>
</body>
</html>
